# 보호 모드로 전환

## GDTR 레지스터 설정

```
lgdt [GDTR] ; GDTR 자료구조를 프로세서에 설정하여 GDT 테이블을 로드
```

보호 모드로 전환하여 인터럽트에 관련된 설정이 완료되기 전에 인터럽트가 발생하면 프로세서는 인터럽트 처리 함수를 찾을 수 없어 예기치 못한 문제가 발생하거나 최악에는 리부팅이 될 수 있다.
인터럽트를 발생할 수 없게 설정하려면 `cli` 명령어를 사용하고 IA-32e 모드로 전환하고 난 뒤, `sti` 명령을 통해 인터럽트를 발생할 수 있게 해주자.

## CR0 컨트롤 레지스터 설정

**CR0 컨트롤 레지스터의 구조와 보호 모드 전환을 위한 설정 값**

![segment descriptor](/contents/dev/2020/04/06/image/os-study-11-1.png)

| 필드           | 설명         |
| ------------- |-------------|
| PE | - Protection Enable의 약자로 보호 모드 진입 여부를 설정 |
|    | - 1로 설정하면 보호모드로 진입하며, 0으로 설정하면 리얼 모드로 진입함 |
| MP | - Monitor Coprocessor의 약자로 wait 또는 fwait 명령 실행 시 TS 필드 참고 여부를 설정 |
|    | - 1로 설정하면 wait 또는 fwait 명령 실행 시 TS 필드가 1이면 Device-not-available 예외가 발생하며, 0으로 설정하면 TS 필드의 값을 무시함 |
| EM | - Emulation의 약자로 프로세서에 FPU 내장되었는지 여부를 설정 |
|    | - 1로 설정하면 FPU 관련 명령 실행 시 Device-not-available 또는 Invalid-opcode 예외가 발생하며, 0으로 설정하면 정상적으로 실행 |
|    | - FPU가 없으면 실수 연산 명령을 소프트웨어적으로 처리할 목적으로 사용 |
| TS | - Task Switched의 약자로 태스크가 전환되었음을 나타냄 |
|    | - 1로 설정하면 FPU 관련 명령실행 시 Device-not-available 예외 발생하며, 0으로 설정하면 FPU 관련 명령을 정상적으로 실행 |
|    | - EM 필드와 MP 필드와 조합하여 FPU를 지원한다는 것을 표시하는 용도로 사용 |
| ET | - Extension Type의 약자로 1로 예약됨 |
|    | - 과거 386, 486 프로세서에서 FPU를 지원한다는 것을 표시하는 용도로 사용 |
| NE | - Numeric Error의 약자로 FPU 에러 처리 여부를 내부 인터럽트 또는 외부 인터럽트 중 선택 |
|    | - 1로 설정하며 FPU 에러를 프로세서 내부의 예외로 연결하며, 0으로 설정하면 인터럽트로 연결함 |
| WP | - Write Protect의 약자로서, 쓰기 금지 기능을 사용할지 여부를 설정 |
|    | - 1로 설정하면 상위 권한(0~2)의 코드가 유저 권한(3)으로 설정된 일기 전용 페이지를 쓸 수 없으며, 0으로 설정하면 페이지 속성에 관계없이 쓸 수 있음 |
| AM | - Alignment Mask의 약자로 어드레스 정렬 검사 기능을 사용할지 여부를 설정 |
|    | - 1로 설정하면 데이터나 어드레스가 특정 값의 배수에서 시작하는지 체크하며, 0으로 설정하면 체크하지 않음 |
| NW | - Not Write-through의 약자로 캐시 정책 중 Write-through를 사용할지 여부를 설정 |
|    | - 1로 설정하며 Write-back 정책을 사용하며, 0으로 설정하면 Write-through 정책을 사용 |
| CD | - Cache Disable의 약자로 프로세서의 캐시를 사용할지 여부를 설정 |
|    | - 1로 설정하면 캐시를 사용하지 않으며, 0으로 설정하면 캐시를 사용함 |
| PG | - Paging의 약자로서, 페이징 기능을 사용할지 여부를 설정 |
|    | - 1로 설정하면 페이징 기능을 사용하며, 0으로 설정하면 페이징 기능을 사용하지 않음 |

우리는 보호 모드를 거쳐 가는 임시 모드로 사용하므로 페이징, 캐시, 메모리 정렬 검사, 쓰기 금지 기능은 모두 사용하지 않고 FPU 역시 쓰지 않으므로 임시 값으로 설정한다.

- x86 프로세서에는 FPU가 내장되어 있으므로 EM 필드를 0으로 설정해서 소프트웨어 에뮬레이션하지 않게 하고 ET 필드를 1
- 임시 초기화를 수행한 것이므로 FPU를 사용하면 정상적으로 작동하지 않기 때문에 MP 필드와 TS 필드와 NE 필드를 1로 설정

```
mov eax, 0x4000003B ; PG=0, CD=1, NW=0, AM=0, WP=0, NE=1, ET=1, TS=1, EM=0, MP=1, PE=1
mov cr0, eax        ; CR0 컨트롤 레지스터에 위에서 저장한 플래그를 설정하여 보호 모드로 전환
```

이제 남은 것은 jmp 명령으로 CS 세그먼트 레지스터를 갱신하고 32비트 코드로 변경하는 것이다.

---

캐시는 프로세서에 내장된 작은 메모리로 외부 메모리의 내용을 일부 저장하여 속도를 높일 목적으로 사용한다.

 - Write-through : 메모리에 쓰기가 수행될 때마다 캐시의 내용과 외부 메모리의 내용을 모두 갱신
 - Write-back : 캐시에만 갱신하고 외부 메모리에 쓰는 작업은 최대한 미뤘다가캐시의 내용을 버릴 때 외부 메모리에 갱신

 여기서는 IA-32e 모드에 진입해서 모든 초기화 작업이 끝나고 나서 캐시를 활성화하고 있다.