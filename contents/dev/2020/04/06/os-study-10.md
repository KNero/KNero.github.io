# GDT 정보 생성

GDT(Global Descriptor Table) 자체는 연속된 디스크립터의 집합으로 우리가 사용하는 코드 세그먼트와 데이터 세그먼트 디스크립터를 연속된 어셈블리어 코드로 나타내면 그 전체 영역이 GDT가 된다.
한 가지 제약 조건은 널 디스크립터(NULL Descriptor)를 가장 앞부분에 추가해야 한다. 
널 디스크립터는 프로세서에 의해서 예약된 디스크립터로 모든 필드가 0으로 초기화된 디스크립터이며 일반적으로 참조되지 않는다.

GDT 정보를 저장하는 자료구조
```
47                        16 15             0
---------------------------------------------
|         32비트             |               |
|          기준              |      크기      |
|          주소              |               |
---------------------------------------------
```

GDT 정보를 저장하는 자료구조의 기준 주소는 32비트의 크기이며, 데이터 세그먼트의 기준 주소와 관계없이 어드레스 0을 기준으로 하는 선형 주소이다.
**따라서 GDT의 시작 어드레스를 실제 메모리 공간상의 어드레스로 변환할 필요가 있다.**

GDT의 선형 주소는 현재 코드가 실행되고 있는 세그먼트의 기준 주소를 알고 있으므로 현재 세그먼트의 시작을 기준으로 GDT의 오프셋을 구하고,
세그먼트 기준 주소를 더해주면 구할 수 있다.

현재 코드는 부트 로더에 의해 `0x10000`에 로딩되어 실행되고 있으므로 자료구조를 생성할 때 GDT 오프셋에 아래의 코드와 같이 0x10000을 더해주면 선형 주소가 된다.

```
; GDTR 자료구조 정의
GDTR:
    dw GDTEND - GDT - 1     ; 아래에 위치하는 GDT 테이블의 전체 크기
    dd (GDT - $$ + 0x10000) ; 아래에 위치하는 GDT 테이블의 시작 어드레스
                            ; 실제 GDT가 있는 선형 주소 계산을 위해 현재 섹션 내의 GDT 오프셋에 세그먼트의 기준 주소인 0x10000 더함

; GDT 테이블 정의
GDT:
    ; 널 디스크립터, 반드시 0으로 초기화해야 함
    NULLDescriptor:
        dw 0x0000
        dw 0x0000
        db 0x00
        db 0x00
        db 0x00
        db 0x00

    ...생략...

    ; 보호 모드 커널용 데이터 세그먼트 디스크립터
    DATADESCRIPTOR:
        dw 0xFFFF   ; Limit [15:0]
        dw 0x0000   ; Base [15:0]
        db 0x00     ; Base [23:16]
        db 0x92     ; P=1, DPL=0, Data Segment, Read/Write
        db 0xCF     ; G=1, D=1, L=0, Limit[19:16]
        db 0x00     ; Base [31:24]
GDTEND:
```

보호 모드로 전환하는 데 필요한 데이터가 모두 준비되었으니 다음에는 프로세서에 준비된 데이터를 설정하여 보호 모드로 전환해 보겠다.

---

GDT 정보를 담는 자료구조에서 GDT의 크기를 나타내는 필드가 2바이트(16비트)이므로 GDT에 포함 가능한 디스크립터(8바이트) 수는 65536(16비트로 표현 가능한 주소 개수, 2^16가지)/8(디스크립터 하나는 8바이트 이므로) 이 되어 최대 8,192개가 된다. 멀티태스킹을 위해 태스크 디스크립터와 태스크별 세그먼트 디스크립터, 기타 디스크립터를 생성하다 보면 공간이 부족할 수 있으므로 LDT(Local Descriptor Table)를 제공한다.