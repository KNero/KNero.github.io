# 인터럽트와 예외

인터럽트와 예외의 차이점은 이벤트를 발생시키는 주체에 있는데 인터럽트는 키보드, 마우스, 하드 디스크 같은 외부 디바이스에 의해 발생하여 프로세서에 전달되는 이벤트이고
예외는 프로세서가 코드를 수행하는 도중에 페이지 폴트나 잘못된 명령 같은 오류를 발견했을 때 발생하는 것이다.
**즉 예외의 주체는 인터럽트와 달리 프로세서 자신이다.**

이벤트가 인터럽트에 의해 발생했든 예외에 의해 발생했든 처리하기 위한 함수가 필요한데 이런 함수를 인터럽트 또는 예외 핸들러라고 부른다.
핸들러는 인터럽트 또는 예외처리 후 발생한 시점으로 정상적으로 복귀하도록 프로세서의 상태를 저장/복구하는 역할도 같이 수행한다.

프로세서는 인터럽트가 발생하면 벡터 테이블의 인덱스에 해당하는 어드레스로 이동하여 처리함수를 수행한다.
리얼 모드의 벡터 테이블은 `0x0000:0x0000` 에 위차하고 보호모드나 IA-32e 모드에서는 `IDT` 라는 벡터 테이블을 사용한다.

`IDT`는 `GDT`와 마찬가지로 IDT 게이트 디스크립터로 구성된 테이블이며, `IDTR` 레지스터를 통해 프로세서에 `IDT` 테이블의 정보를 설정할 수 있다.
IDT 테이블은 최대 256개의 엔트리를 포함할 수 있고, IA-32e 모드의 IDT 게이트 디스크립터는 16바이트를 차지한다.

![idt](/contents/dev/2020/06/08/image/os-study-32-1.png)

IDT 게이트 디스크립터는 세그먼트 셀렉터를 포함하는데 이 세그먼트 셀렉터는 인터럽트 또는 예외 핸들러가 수행될 때 코드 세그먼트를 교체하여, 핸들러 함수를 수행하는데 충분한 권한(특권 레벨)으로 상승시키는 역할을 한다.
이유는 애플리케이션 코드를 실행하는 도중 인터럽트 또는 예외가 발생할 경우 커널 영역에 있는 핸들러를 실행하면 권한 문제로 요류가 발생하기 때문이다.

`IST`는 IA-32e 모드에서 도입된 새로운 개념으로 보호 모드에서는 지원하지 않는 기능이다. 
IST는 인터럽트 스택 테이블(Interrupt Stack Table)의 약자로 인터럽트나 예외가 발생했을 때 별도의 스택 공간을 할당하는 기능으로 
별도의 스택 공산을 할당하는 이유는 핸들러를 수행하는 도중 스택 공간이 부족하여 코드나 데이터 영역을 덮었는 불상사를 막기 위해서이다.

수행 중이던 코드가 스택을 거의 다 할당할 정도로 지역 변수를 사용하고 있을 때 핸들러가 수행된다면 스택 범위를 초과하여 다른 영역을 침범할 것이다.
다른 영역을 침범하면 코드로 복귀했을 때 코드 데이터가 변경되어 정상적으로 수행되지 않는다. 

MINT64 OS 역시 IST 방식을 사용하여 스택 부족으로 발생하는 문제를 해결할 것이다.

### 스택 스위칭과 IST

x86 프로세서는 인터럽트나 예외가 발생했을 때, IDT 게이트 디스크립터에 설정된 코드 디스크립터의 권한이 현재 수행 중인 코드의 권한 보다 높으면 새로운 스택으로 전환한다.
이러한 과정을 스택 스위칭이라고 하며, 스택 스위칭을 하는 이유는 크게 두 가지 이다.

1. 높은 권한의 코드, 즉 핸들러가 스택 공간의 부족으로 오류가 발생하는 일을 미리 방지힌다.
2. 권한이 높은 함수가 낲은 권한의 스택을 공유함으로써 발생할 수 있는 간섭을 최소화 한다.

보호 모드의 스택 스위칭은 권한이 변경되어야만 발생하기 때문에 커널 코드를 실행하다가 인터럽트가 발생하면, 권한의 변동이 없으므로 스택이 스위칭되지 않는다.
이 문제를 해결하기 위해 IA-32e 모드에서는 `IST(Interrupt Stack Table)` 이라는 기법을 도입했다.

IST는 스택을 정의하는 테이블로 최대 7개의 스택을 지정하고 무조건 스택 스위칭이 발생한다.
MINT64 OS 역시 IST를 사용하며 커널 스택 영역 이후 7MB~8MB 영역을 IST 공간으로 할당한다.

IST 스택을 사용하는 방법은 IDT 테이블의 해당 게이트 디스크립터를 찾아 IST 필드를 1~7사이의 값으로 설정하면 된다. 
IST 필드를 0으로 설정하면 기존의 스택 스위칭 방식을 사용한다.

### 프로세서와 태스크 상태 세그먼트, 태스크 디스크립터

태스크 상태 세그먼트(TSS)는 태스크의 상태를 저장하는 영역으로 프로세서의 상태, 특 레지스터의 값을 저장하는 역할을 한다.
보호 모드의 TSS는 FPU에 관련된 레지스터를 제외한 프로세서의 모든 레지스터를 저장할 수 있으며, 하드웨어 멀티태스킹 구현에서 핵심 역할을 맡는다.

하지만 IA-32e 모드에서는 레지스터의 크기가 커지면서 기존의 104 바이트로는 모든 레지스터를 담을 수 없게 되었고 총 7개의 IST의 정보를 저장하는 역할로 변경되었다.

그리고 프로세서가 TSS 세그먼트를 참조할 수 있게 TSS 세그먼트의 어드레스를 알려줘야 한다. 프로세서에 TSS 세그먼트에 대한 정보를 알려주는 역할을 하는 것이 
TSS 디스크립터와 `LTR` 어셈블리어 명령어이다.